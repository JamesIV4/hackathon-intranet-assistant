## Goal  
  
To detect a change in the Echo Canceler's behavior and determine whether it represents an improvement or a regression.

## Challenges

The two types of Echo Canceler errors are over-application (reducing legitimate speech) and under-application (failing to reduce echo).

To automatically detect whether a change is an improvement or regression is difficult, though, because attenuation isn't a discrete process: the percentage of attenuated frames per segment may change, but also the degree of attenuation in a frame may change as well, and either or both can affect recognition rates.

By annotating the test files and tracking attenuation in segments identified as 'speech' and segments identified as 'echo' in the annotation file, we can automatically mark segments of the recording where the Echo Canceler seems to be performing better or worse than it was previously, but a human still needs to listen to both versions to make the final determination.

## Measuring attenuation

Our previous approach used a large CSV file (105 fields per frame) generated by the Signal Conditioner. One of those fields, residual loss, was used to determine the percentage of attenuated frames for each segment, and then percentages were reported and evaluated based on the segment type (speech, echo, or silence).

We encountered two issues with the previous approach:

1\. We needed to compare new to baseline, but the CSV files were massive, so they were difficult to check into p4  
2\. The way residual loss is measured has changed over time, so when we ran older versions, we weren't getting a true comparison.

Our current approach measures attenuation by evaluating the input and output audio files directly. Since output audio is offset from the input, we have to align them to compare the dB values in corresponding frames and to correctly identify which segment a frame belongs to.

To align the output audio to the input, we apply a range of offsets, measuring the dB gain or loss from input to output, and selecting the offset that produces the lowest average gain.

## Setting the dB difference threshold

Per-segment results are reported in terms of percentage-of-frames with reduction, but we use a dB threshold to decide whether a frame should be considered reduced.

We arrived at the value of 4.0dB experimentally but subjectively, by checking the output reports at various threshold levels and listening to the segments where those reported values had changed, to decide which value seemed more appropriate for describing that degree of attenuation.

## Interface

Like the other regression tests (TTS, ISR, KWS), the Echo Canceler regression test generates an html page with the results here: pub\gen\integ_tests\junit\ippspeechcoding\echo_canceller, and it opens when you run 'rake test' locally. This page lists each audio file used in the test, showing whether it has changed from the output of the previous version, and also allowing the user to expand the display to show segment-by-segment changes, and to play the old and new audio side-by-side for comparison.

As of late March 2018, the Echo Canceler uses XMLRunner to generate its own build artifact called test_results.xml. This file shows the time for each test case to run, and reports any checksum difference in the audio file output as an error. (It does not report segment-by-segment changes, though.)

 
